<?xml version="1.0"?>
<ruleset name="WP Migrate Coding Standards">
    <description>WordPress Coding Standards for WP Migrate Plugin</description>

    <!-- Files to check -->
    <file>.</file>

    <!-- Exclude paths -->
    <exclude-pattern>*/node_modules/*</exclude-pattern>
    <exclude-pattern>*/vendor/*</exclude-pattern>
    <exclude-pattern>*/build/*</exclude-pattern>
    <exclude-pattern>*/tests/data/*</exclude-pattern>
    <exclude-pattern>*.min.js</exclude-pattern>
    <exclude-pattern>*.min.css</exclude-pattern>

    <!-- Include the WordPress-Extra standard. -->
    <rule ref="WordPress-Extra">
        <!-- Allow array short syntax -->
        <exclude name="Generic.Arrays.DisallowShortArraySyntax"/>
        
        <!-- Allow short echo syntax -->
        <exclude name="WordPress.PHP.DisallowShortTernary"/>
        
        <!-- Allow file names with underscores -->
        <exclude name="WordPress.Files.FileName"/>
        
        <!-- Allow multiple assignments in one line -->
        <exclude name="Squiz.PHP.DisallowMultipleAssignments"/>
    </rule>

    <!-- Include the WordPress-Docs standard for documentation. -->
    <rule ref="WordPress-Docs"/>

    <!-- Verify that the text_domain is set to the desired text-domain. -->
    <rule ref="WordPress.WP.I18n">
        <properties>
            <property name="text_domain" type="array" value="wp-migrate"/>
        </properties>
    </rule>

    <!-- Allow for theme specific exceptions to the file name rules based on the theme hierarchy. -->
    <rule ref="WordPress.Files.FileName">
        <properties>
            <property name="is_theme" value="false"/>
        </properties>
    </rule>

    <!-- Set the minimum supported WP version. -->
    <rule ref="WordPress.WP.DeprecatedFunctions">
        <properties>
            <property name="minimum_supported_version" value="5.0"/>
        </properties>
    </rule>

    <!-- Enforce PSR-4 naming conventions for classes -->
    <rule ref="PSR1.Classes.ClassDeclaration"/>

    <!-- Use modern array syntax -->
    <rule ref="Generic.Arrays.DisallowLongArraySyntax"/>

    <!-- Disallow closing tag for PHP-only files -->
    <rule ref="PSR2.Files.ClosingTag"/>

    <!-- Encourage use of strict comparisons -->
    <rule ref="WordPress.PHP.StrictComparisons"/>

    <!-- Encourage use of wp_safe_redirect() to avoid open redirect vulnerabilities -->
    <rule ref="WordPress.Security.SafeRedirect"/>

    <!-- Check for PHP cross-version compatibility -->
    <config name="testVersion" value="7.4-"/>
    <rule ref="PHPCompatibilityWP"/>

    <!-- Configuration for specific file extensions -->
    <arg name="extensions" value="php"/>
    
    <!-- Show progress -->
    <arg value="p"/>
    
    <!-- Show sniff codes in all reports -->
    <arg value="s"/>
    
    <!-- Use colors in output -->
    <arg name="colors"/>
    
    <!-- Show results with . progress -->
    <arg value="n"/>

    <!-- Additional rules for security -->
    <rule ref="WordPress.Security.ValidatedSanitizedInput"/>
    <rule ref="WordPress.Security.EscapeOutput"/>
    <rule ref="WordPress.Security.NonceVerification"/>

    <!-- Database query rules -->
    <rule ref="WordPress.DB.DirectDatabaseQuery">
        <properties>
            <!-- Allow direct database queries for migration operations -->
            <property name="customQueryHandling" type="array" value="true"/>
        </properties>
    </rule>
    <rule ref="WordPress.DB.PreparedSQL"/>

    <!-- Filesystem rules -->
    <rule ref="WordPress.WP.AlternativeFunctions">
        <properties>
            <!-- Allow file system functions for backup/restore operations -->
            <property name="exclude" type="array">
                <element value="file_get_contents"/>
                <element value="file_put_contents"/>
                <element value="fopen"/>
                <element value="fwrite"/>
                <element value="fclose"/>
            </property>
        </properties>
    </rule>

    <!-- Allow WordPress VIP-specific exclusions for migration operations -->
    <rule ref="WordPress.PHP.DiscouragedPHPFunctions">
        <properties>
            <property name="exclude" type="array">
                <element value="exec"/>
                <element value="shell_exec"/>
                <element value="system"/>
            </property>
        </properties>
    </rule>

    <!-- Customizations for specific directories -->
    
    <!-- Tests directory - more lenient rules -->
    <rule ref="WordPress.PHP.DevelopmentFunctions">
        <exclude-pattern>*/tests/*</exclude-pattern>
    </rule>
    
    <!-- CLI directory - allow more direct system access -->
    <rule ref="WordPress.PHP.DiscouragedPHPFunctions">
        <exclude-pattern>*/cli/*</exclude-pattern>
    </rule>
    
    <!-- Core directory - allow advanced functionality -->
    <rule ref="WordPress.DB.DirectDatabaseQuery">
        <exclude-pattern>*/core/*</exclude-pattern>
    </rule>
</ruleset>